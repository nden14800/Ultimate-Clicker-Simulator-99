<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Clicker Simulator 99 - v7.0 Perfect Balance</title>
    
    <!-- External Library for Infinite Numbers -->
    <script src="https://cdn.jsdelivr.net/npm/break_infinity.js@2/dist/break_infinity.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --panel-bg: rgba(20, 25, 40, 0.95);
            --accent: #00d2ff;
            --text-main: #ffffff;
            --btn-green: #2ecc71;
            --btn-green-shadow: #27ae60;
            
            /* Rarity Colors */
            --rarity-basic: #b2bec3;
            --rarity-rare: #55efc4;
            --rarity-epic: #0984e3;
            --rarity-legendary: #fdcb6e;
            --rarity-mythical: #d63031;
            --rarity-divine: #e056fd;
            --rarity-exclusive: #6c5ce7;
            --rarity-secret: #000000;
            --rarity-taco: #f1c40f;
            --rarity-potion: #e84393;
            --rarity-godly: #ff0055;
            --rarity-zenith: #ffffff;
            --rarity-void: #4b0082;
            --rarity-omega: #ff4500;
            --rarity-infinity: #33ff33;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            font-family: 'Fredoka', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background 1s ease;
        }

        /* --- Notification Area --- */
        #notification-area {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 11000;
            pointer-events: none; width: 90%; max-width: 400px;
        }
        .custom-notif {
            background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 25px;
            border-radius: 50px; border: 2px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            font-weight: 700; text-align: center; font-size: 0.95rem;
            animation: notifSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, notifFadeOut 0.5s ease-in 3.5s forwards;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            backdrop-filter: blur(8px);
        }
        @keyframes notifSlideIn { from { transform: translateY(-50px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes notifFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

        /* --- Tooltip --- */
        #custom-tooltip {
            position: fixed;
            background: rgba(15, 15, 20, 0.98);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            pointer-events: none;
            z-index: 12000;
            display: none;
            min-width: 250px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            transition: border-color 0.2s;
        }
        .tooltip-header { font-weight: 800; font-size: 1.2rem; border-bottom: 1px solid #444; padding-bottom: 8px; margin-bottom: 8px; color: #fff; }
        .tooltip-desc { font-size: 0.95rem; color: #ccc; margin-bottom: 10px; line-height: 1.4; }
        .rarity-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3);
        }

        .stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 6px solid transparent;
            transition: transform 0.2s, background 0.2s;
        }
        .stat-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.12); }
        .stat-icon { font-size: 1.8rem; }
        .stat-info { display: flex; flex-direction: column; overflow: hidden; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 1.2rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .rebirth-stat-box {
            background: linear-gradient(135deg, rgba(142, 68, 173, 0.4), rgba(155, 89, 182, 0.2));
            border: 1px solid rgba(142, 68, 173, 0.5);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .rebirth-val { font-weight: 900; color: #e056fd; text-shadow: 0 0 5px rgba(224, 86, 253, 0.5); }

        .sidebar-btn {
            background: #34495e; color: white; border: 2px solid #2c3e50;
            padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 10px; justify-content: center;
            transition: 0.2s; margin-top: 5px; box-shadow: 0 4px 0 #2c3e50;
        }
        .sidebar-btn:active { transform: translateY(4px); box-shadow: none; }
        .sidebar-btn:hover { background: #3e5871; }

        /* --- Active Buffs --- */
        #active-buffs {
            position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column-reverse; gap: 10px; z-index: 1500;
        }
        .buff-pill {
            background: rgba(20, 20, 30, 0.9); border: 2px solid #555; padding: 10px 18px; border-radius: 30px;
            color: white; display: flex; align-items: center; gap: 12px; font-weight: bold; font-size: 0.95rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: fit-content; transition: transform 0.2s;
        }
        .buff-intro { animation: slideIn 0.3s ease-out; }
        .buff-pill:hover { transform: scale(1.05); }
        @keyframes slideIn { from{transform:translateX(-100%); opacity:0;} to{transform:translateX(0); opacity:1;} }

        /* --- Main Area --- */
        .main-area {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        .cps-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .cps-badge {
            background: rgba(0,0,0,0.4); padding: 8px 20px; border-radius: 20px;
            color: rgba(255,255,255,0.9); font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .click-zone { width: 340px; height: 340px; position: relative; z-index: 10; }
        
        #click-btn {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff7675, #d63031);
            border: 12px solid #fff;
            box-shadow: 0 15px 0 #c0392b, 0 30px 60px rgba(0,0,0,0.5), inset 0 10px 20px rgba(255,255,255,0.2);
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            font-size: 7rem; color: white; transition: transform 0.05s; outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        #click-btn:active { transform: scale(0.95) translateY(10px); box-shadow: 0 5px 0 #c0392b; }

        .floating-text {
            position: absolute; font-weight: 900; pointer-events: none;
            text-shadow: 2px 2px 0 #000; animation: floatUp 0.8s ease-out forwards;
            white-space: nowrap; z-index: 50; font-size: 1.5rem;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1) rotate(var(--rot)); opacity: 1; }
            100% { transform: translateY(-150px) scale(1.2) rotate(var(--rot)); opacity: 0; }
        }

        /* --- Smooth Progress Bar --- */
        #world-progress-container {
            width: 300px;
            height: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            margin-top: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }
        #world-progress-bar {
            height: 100%;
            width: 0%;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(255,255,255,0.7);
            transition: width 0.1s linear; /* Smooth movement */
        }
        #world-progress-text {
            font-size: 0.85rem; margin-top: 5px; color: #ccc; font-weight: bold;
        }

        /* --- Right Panel --- */
        .right-panel {
            width: 550px; background: var(--panel-bg); border-left: 2px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; z-index: 90; box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        }

        .tab-header {
            display: flex; overflow-x: auto; background: rgba(0,0,0,0.4);
            padding: 10px 5px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tab-header::-webkit-scrollbar { height: 4px; }
        .tab-header::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        .tab-btn {
            flex: 0 0 auto; background: transparent; border: none; color: #aaa;
            padding: 12px 18px; font-weight: 700; cursor: pointer;
            border-bottom: 4px solid transparent; transition: 0.2s; font-size: 1rem; margin-right: 5px;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active { color: white; border-bottom-color: var(--accent); background: rgba(255,255,255,0.1); border-radius: 8px 8px 0 0; }

        /* --- Bulk Controls --- */
        .bulk-controls {
            padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }
        .bulk-row { display: flex; align-items: center; gap: 10px; justify-content: space-between; }
        .bulk-label { font-size: 0.9rem; color: #ccc; font-weight: bold; }
        
        .bulk-btn-group { display: flex; gap: 5px; }
        .bulk-btn {
            background: #34495e; color: white; border: 1px solid #555;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.1s;
        }
        .bulk-btn:hover { background: #45627d; }
        .bulk-btn.active { background: var(--btn-green); border-color: var(--btn-green-shadow); font-weight: bold; box-shadow: 0 0 10px rgba(46, 204, 113, 0.4); }
        
        .bulk-slider { flex: 1; accent-color: var(--accent); cursor: pointer; height: 6px; }
        .bulk-input { width: 80px; background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; padding: 6px; border-radius: 6px; text-align: center; font-weight: bold; }

        .tab-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .tab-content.active { display: block; }
        .tab-content::-webkit-scrollbar { width: 8px; }
        .tab-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* --- Items --- */
        .item-card {
            background: linear-gradient(to bottom, #ffffff, #ecf0f1);
            color: #333; padding: 12px; border-radius: 14px; margin-bottom: 12px;
            display: grid; grid-template-columns: 55px 1fr auto; align-items: center; gap: 15px;
            border-bottom: 5px solid #bdc3c7; position: relative; transition: all 0.1s;
        }
        .item-card:hover { transform: scale(1.01); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .item-card.locked-upgrade { filter: grayscale(1); opacity: 0.7; background: #95a5a6; pointer-events: none; }
        .item-type-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; font-weight: bold; text-transform: uppercase; }
        .badge-auto { background: #3498db; }
        .badge-click { background: #e67e22; }
        .badge-gold { background: #f1c40f; color: #333; }
        .badge-diamond { background: #9b59b6; }
        .badge-chance { background: #e056fd; }
        
        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 5; background: rgba(0,0,0,0.1); border-radius: 14px;
        }
        .lock-badge {
            background: #c0392b; color: white; padding: 5px 15px;
            border-radius: 20px; font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4); border: 2px solid white; display: flex; align-items: center; gap: 5px;
        }
        .item-icon {
            width: 55px; height: 55px; background: #eee; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid #ddd;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .buy-btn {
            background: var(--btn-green); color: white; border: none; padding: 8px 16px;
            border-radius: 10px; font-weight: 700; cursor: pointer; border-bottom: 4px solid var(--btn-green-shadow);
            min-width: 100px; font-size: 0.9rem; text-align: center; transition: 0.1s;
        }
        .buy-btn:disabled { background: #95a5a6; border-color: #7f8c8d; opacity: 0.8; cursor: not-allowed; transform: none; border-bottom-width: 4px; }
        .buy-btn:active:not(:disabled) { transform: translateY(4px); border-bottom: 0; margin-bottom: 4px; }
        .diamond-item { background: linear-gradient(to bottom, #e3f2fd, #bbdefb); border: 2px solid #2196f3; }
        .diamond-btn { background: #2196f3; border-color: #1565c0; }

        /* --- Inventory --- */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; padding-bottom: 20px; }
        .pet-slot {
            aspect-ratio: 1; background: #333; border-radius: 10px; position: relative;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            border: 2px solid #555; transition: transform 0.1s; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .pet-slot:hover { transform: scale(1.1); z-index: 2; }
        .equipped-marker {
            position: absolute; top: -5px; right: -5px; background: #2ecc71; border: 2px solid #fff;
            width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* --- Rebirth Modal UI --- */
        .rebirth-modal-center {
            display: flex; flex-direction: column; align-items: center; width: 100%; color: #fff;
        }
        .progress-circle-container {
            width: 220px; height: 220px; position: relative; display: flex; align-items: center; justify-content: center; margin: 25px 0;
        }
        .progress-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 12; }
        .progress-circle-fg { 
            fill: none; stroke: #e056fd; stroke-width: 12; stroke-linecap: round; 
            stroke-dasharray: 628; stroke-dashoffset: 628; transition: stroke-dashoffset 0.5s linear; 
            filter: drop-shadow(0 0 5px #e056fd);
        }
        .progress-text { position: absolute; font-size: 2.5rem; font-weight: 900; color: white; text-shadow: 0 0 20px #e056fd; }
        
        .rebirth-info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; border: 1px solid #444;
        }
        .rebirth-info-col h3 { margin: 0 0 15px 0; font-size: 1.2rem; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .rebirth-list-item { font-size: 1rem; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; text-align: left; }
        .lost-item { color: #ff7675; }
        .kept-item { color: #55efc4; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .egg-modal-content {
            background: #fff; color: #333; border-radius: 30px; border: 8px solid #333;
            width: 95%; max-width: 600px; text-align: center; position: relative;
            max-height: 90vh; display: flex; flex-direction: column;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .egg-scroll-area { overflow-y: auto; flex: 1; padding-bottom: 20px; }
        
        .egg-modal-header { font-size: 1.8rem; font-weight: 900; margin-top: 25px; margin-bottom: 10px; color: #2d3436; text-transform: uppercase; }
        .egg-image-large { font-size: 8rem; margin: 10px 0; animation: floatEgg 3s ease-in-out infinite; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.2)); }
        @keyframes floatEgg { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
        
        .egg-buy-section { background: #dfe6e9; padding: 20px; border-top: 3px solid #b2bec3; }
        .amount-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .amt-btn {
            background: #fff; border: 2px solid #bdc3c7; border-radius: 8px; padding: 8px; font-weight: 800; cursor: pointer; color: #555; transition: 0.1s;
        }
        .amt-btn:hover { background: #ecf0f1; }
        .amt-btn.selected { background: #0984e3; color: white; border-color: #00cec9; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); }

        .egg-actions-row { display: flex; gap: 10px; justify-content: center; }
        .action-main-btn {
            flex: 1; padding: 12px; border-radius: 12px; font-weight: 900; cursor: pointer; border: 3px solid rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .btn-buy-once { background: #2ecc71; color: white; border-color: #27ae60; }
        .btn-buy-once:active { transform: translateY(2px); }
        .btn-auto-hatch { background: #e67e22; color: white; border-color: #d35400; }
        .btn-auto-hatch.active { background: #e74c3c; animation: pulseRed 1s infinite; border-color: #c0392b; }
        @keyframes pulseRed { 0%{box-shadow:0 0 0 0 rgba(231, 76, 60, 0.7);} 70%{box-shadow:0 0 0 10px rgba(231, 76, 60, 0);} 100%{box-shadow:0 0 0 0 rgba(231, 76, 60, 0);} }

        .cost-display { font-size: 1.1rem; margin-top: 5px; display: flex; align-items: center; gap: 5px; }

        .close-btn {
            position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white;
            width: 40px; height: 40px; border-radius: 10px; font-size: 1.5rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 3px solid #c0392b; z-index: 100;
        }
        @keyframes popIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

        /* Hatch Anim */
        .hatch-grid { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; max-width: 800px; padding: 20px; }
        .hatch-card {
            width: 100px; height: 130px; background: white; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            animation: cardPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: scale(0.5); border: 4px solid transparent;
        }
        .hatch-card i { font-size: 2.5rem !important; margin-bottom: 5px; }
        .hatch-name { font-weight: bold; font-size: 0.75rem; text-align:center; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; width:90%; color:#333; }
        .hatch-rarity { font-size: 0.6rem; text-transform:uppercase; font-weight:bold; }
        @keyframes cardPop { to { opacity:1; transform:scale(1); } }

        /* Explanation Box in Settings */
        .settings-info {
            background: #f1f2f6; border: 1px solid #ccc; padding: 10px; border-radius: 10px; margin-top: 15px; font-size: 0.9rem; color: #333; text-align: left;
        }
        .settings-info h4 { margin: 5px 0; color: #2c3e50; }

        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; height: auto; flex-direction: row; flex-wrap: wrap; padding: 10px; }
            .stat-card { padding: 10px; flex: 1; min-width: 140px; }
            .main-area { min-height: 450px; padding: 20px 0; }
            .right-panel { width: 100%; min-height: 600px; }
            .click-zone { width: 260px; height: 260px; }
            #click-btn { font-size: 5rem; }
            .egg-modal-content { width: 95%; height:80vh; }
            #active-buffs { bottom: 10px; left: 10px; }
        }
    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="active-buffs"></div>

    <div id="custom-tooltip">
        <div class="tooltip-header" id="tt-title"></div>
        <div class="tooltip-desc" id="tt-desc"></div>
        <div id="tt-stats"></div>
    </div>

    <audio id="bgm-player" loop></audio>

    <div class="sidebar">
        <div class="stat-card" style="border-color: #f1c40f;">
            <i class="bi bi-cursor-fill stat-icon" style="color: #f1c40f;"></i>
            <div class="stat-info">
                <span class="stat-label">クリック数</span>
                <span class="stat-value" id="disp-clicks">0</span>
            </div>
        </div>
        <div class="stat-card" style="border-color: #00d2ff;">
            <i class="bi bi-gem-fill stat-icon" style="color: #00d2ff;"></i>
            <div class="stat-info">
                <span class="stat-label">ダイヤ</span>
                <span class="stat-value" id="disp-gems">0</span>
            </div>
        </div>
        
        <div class="rebirth-stat-box">
            <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">リバース回数</div>
            <div class="rebirth-val" id="disp-rebirths">0</div>
            <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-top:5px;">現在倍率</div>
            <div class="rebirth-val" id="disp-rebirth-multi">x1.0</div>
        </div>

        <div style="margin-top:auto; display:flex; flex-direction:column; gap:10px; width:100%;">
            <button class="sidebar-btn" onclick="openModal('settings-modal')">
                <i class="bi bi-gear-fill" style="color:#bdc3c7;"></i> 設定
            </button>
        </div>
    </div>

    <div class="main-area">
        <div class="cps-container">
            <div class="cps-badge"><i class="bi bi-lightning-charge-fill"></i> <span id="auto-cps">0</span> 自動/秒</div>
            <div class="cps-badge"><i class="bi bi-hand-index-thumb-fill"></i> <span id="manual-cps">0</span> 手動/秒</div>
        </div>

        <div class="click-zone">
            <button id="click-btn">
                <i class="bi bi-cursor-fill"></i>
            </button>
        </div>
        <div style="margin-top:20px; text-align:center; opacity:0.9; display:flex; flex-direction:column; align-items:center;">
            <div id="world-badge" style="font-size:1.3rem; font-weight:800; background:rgba(0,0,0,0.6); padding:10px 25px; border-radius:25px; border:2px solid rgba(255,255,255,0.2);">
                <i class="bi bi-globe"></i> オーバーワールド
            </div>
            <!-- New Smooth Progress Bar -->
            <div id="world-progress-container">
                <div id="world-progress-bar"></div>
            </div>
            <div id="world-progress-text">次のワールドまで: 0%</div>
        </div>
    </div>

    <div class="right-panel">
        <div class="tab-header">
            <button class="tab-btn active" onclick="switchTab('upgrades')"><i class="bi bi-arrow-up-circle"></i> 施設</button>
            <button class="tab-btn" onclick="switchTab('eggs')"><i class="bi bi-egg-fill"></i> 卵</button>
            <button class="tab-btn" onclick="switchTab('pets')"><i class="bi bi-backpack-fill"></i> ペット</button>
            <button class="tab-btn" onclick="switchTab('shop')"><i class="bi bi-cart-fill"></i> ダイヤ店</button>
            <button class="tab-btn" onclick="switchTab('worlds')"><i class="bi bi-globe"></i> ワールド</button>
            <button class="tab-btn" onclick="switchTab('rebirth')"><i class="bi bi-arrow-repeat"></i> リバース</button>
        </div>

        <div class="bulk-controls">
            <div class="bulk-row">
                <div class="bulk-label">購入数: <span id="buy-amount-display" style="color:#2ecc71">1</span></div>
                <div class="bulk-btn-group">
                    <button class="bulk-btn active" onclick="setBuyMode(1)">1x</button>
                    <button class="bulk-btn" onclick="setBuyMode(10)">10x</button>
                    <button class="bulk-btn" onclick="setBuyMode(100)">100x</button>
                    <button class="bulk-btn" onclick="setBuyMode('max')">MAX</button>
                </div>
            </div>
            <div class="bulk-row">
                <input type="range" class="bulk-slider" min="1" max="1000" value="1" oninput="updateBulkSlider(this.value)">
                <input type="number" class="bulk-input" min="1" value="1" onchange="updateBulkInput(this.value)">
            </div>
        </div>

        <div id="tab-upgrades" class="tab-content active"></div>
        <div id="tab-eggs" class="tab-content"><div id="egg-list"></div></div>
        <div id="tab-pets" class="tab-content">
            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-size:0.9rem;">装備中: <span id="equip-count">0</span>/5</span>
                <span style="font-size:0.9rem; color:#bbb;">所持数: <span id="total-pet-count" style="color:white; font-weight:bold;">0</span>体</span>
                <button class="buy-btn" style="min-width:auto; font-size:0.8rem; padding:6px 12px;" onclick="equipBest()">
                    <i class="bi bi-lightning-fill"></i> 最強装備
                </button>
            </div>
            <div id="inventory-container" class="inventory-grid"></div>
        </div>
        <div id="tab-shop" class="tab-content"></div>
        <div id="tab-worlds" class="tab-content">
            <div id="next-world-timer" style="margin-bottom:15px; padding:10px; background:rgba(0,0,0,0.5); border-radius:8px; font-weight:bold; color:#f1c40f; text-align:center;">
                次のワールドまで: 計算中...
            </div>
            <div id="worlds-list"></div>
        </div>
        
        <div id="tab-rebirth" class="tab-content">
            <div class="rebirth-container">
                <h2 style="color:#f1c40f; text-shadow:0 0 10px #f1c40f;">REBIRTH</h2>
                <p style="max-width:300px; color:#ccc;">リバースを行うと、進行状況をリセットして永続的な強さを手に入れます。</p>
                <div class="rebirth-visual">
                    <i class="bi bi-arrow-repeat" style="font-size:5rem; color:#9b59b6;"></i>
                </div>
                <button class="buy-btn" style="font-size:1.5rem; padding:15px 40px; background:#9b59b6; border-color:#8e44ad;" onclick="openModal('rebirth-modal')">
                    リバース画面へ
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="rebirth-modal" class="modal-overlay">
        <div class="egg-modal-content" style="max-width:500px; background: #2d3436; color:white; border:none;">
            <div class="close-btn" onclick="closeModal('rebirth-modal')">&times;</div>
            <div class="egg-scroll-area" style="padding:20px;">
                <h2 style="margin:0; color:#f1c40f; font-size:2rem; text-shadow:0 0 10px rgba(241, 196, 15, 0.5);">REBIRTH</h2>
                
                <div class="rebirth-modal-center">
                    <div class="progress-circle-container">
                        <svg class="progress-svg">
                            <circle class="progress-circle-bg" cx="110" cy="110" r="100"></circle>
                            <circle class="progress-circle-fg" id="rebirth-progress-circle" cx="110" cy="110" r="100"></circle>
                        </svg>
                        <div class="progress-text" id="rebirth-progress-text">0%</div>
                    </div>
                    <div style="font-size:1.3rem; font-weight:bold; margin-bottom:15px; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:50px;">
                        コスト: <span id="rebirth-cost-final" style="color:#f1c40f;">1.00 M</span>
                    </div>
                    
                    <div class="rebirth-info-grid">
                        <div class="rebirth-info-col">
                            <h3 class="lost-item"><i class="bi bi-x-circle-fill"></i> リセット対象</h3>
                            <div class="rebirth-list-item lost-item">クリック数</div>
                            <div class="rebirth-list-item lost-item">施設レベル</div>
                            <div class="rebirth-list-item lost-item">ワールド進行</div>
                        </div>
                        <div class="rebirth-info-col">
                            <h3 class="kept-item"><i class="bi bi-check-circle-fill"></i> 引き継ぎ</h3>
                            <div class="rebirth-list-item kept-item">所持ペット</div>
                            <div class="rebirth-list-item kept-item">ダイヤ残高</div>
                            <div class="rebirth-list-item kept-item">ポーション</div>
                            <div class="rebirth-list-item kept-item">ランキング</div>
                            <div class="rebirth-list-item kept-item">実績データ</div>
                        </div>
                    </div>

                    <div style="background:linear-gradient(90deg, rgba(46, 204, 113, 0.2), rgba(46, 204, 113, 0.4)); border:2px solid #2ecc71; padding:15px; border-radius:15px; margin-top:20px; width:100%; box-shadow:0 0 20px rgba(46, 204, 113, 0.3);">
                        <div style="font-size:0.9rem; color:#badc58; margin-bottom:5px;">リバース報酬</div>
                        <div style="font-weight:900; color:#fff; font-size:1.5rem; text-shadow:0 0 10px #2ecc71;" id="rebirth-reward-display">+100% 永続倍率</div>
                    </div>
                </div>

                <button id="rebirth-execute-btn" class="buy-btn" style="width:100%; margin-top:25px; font-size:1.8rem; background:#9b59b6; border-color:#8e44ad; padding:15px; box-shadow:0 10px 0 #732d91;" onclick="doRebirth()">
                    リバース実行！
                </button>
            </div>
        </div>
    </div>

    <div id="egg-buy-modal" class="modal-overlay">
        <div class="egg-modal-content">
            <div class="close-btn" onclick="closeModal('egg-buy-modal')">&times;</div>
            <div class="egg-scroll-area">
                <div class="egg-modal-header">卵を購入</div>
                <div class="egg-image-large"><i class="bi bi-egg-fill" style="color:#ffeaa7;"></i></div>
                <div style="font-size:1.5rem; margin-bottom:10px; font-weight:bold; color:#555;" id="modal-egg-name">Egg Name</div>
                
                <div class="egg-buy-section">
                    <div style="font-weight:bold; color:#555; margin-bottom:5px;">個数を選択:</div>
                    <div class="amount-selector">
                        <button class="amt-btn selected" onclick="selectEggAmount(1)">1</button>
                        <button class="amt-btn" onclick="selectEggAmount(3)">3</button>
                        <button class="amt-btn" onclick="selectEggAmount(5)">5</button>
                        <button class="amt-btn" onclick="selectEggAmount(10)">10</button>
                        <button class="amt-btn" onclick="selectEggAmount(25)">25</button>
                        <button class="amt-btn" onclick="selectEggAmount(50)">50</button>
                        <button class="amt-btn" onclick="selectEggAmount(100)">100</button>
                        <button class="amt-btn" onclick="selectEggAmount('max')">MAX</button>
                    </div>

                    <div class="egg-actions-row">
                        <button class="action-main-btn btn-buy-once" onclick="executeBuyEgg()">
                            <div><i class="bi bi-cart-fill"></i> 購入</div>
                            <div class="cost-display" id="egg-cost-disp"><i class="bi bi-mouse-fill"></i> 0</div>
                        </button>
                        <button class="action-main-btn btn-auto-hatch" id="btn-auto-hatch" onclick="toggleAutoHatch()">
                            <i class="bi bi-arrow-repeat" style="font-size:1.5rem;"></i>
                            <div>Auto Hatch</div>
                            <div style="font-size:0.8rem;" id="auto-status-text">OFF</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hatch-modal" class="modal-overlay">
        <div class="egg-modal-content" style="background:transparent; border:none; box-shadow:none; overflow:visible;">
            <div style="text-align:center; width:100%;">
                <h1 style="color:white; text-shadow:0 0 10px #000; margin-bottom:30px; font-size:3rem; font-weight:900;">GET!</h1>
                <div class="egg-scroll-area" style="max-height:60vh; overflow-y:auto; padding:10px;">
                    <div id="hatch-result-container" class="hatch-grid"></div>
                </div>
                <button class="buy-btn" style="margin-top:20px; font-size:1.5rem; padding:15px 50px;" onclick="closeHatchModal()">閉じる</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="egg-modal-content">
            <div class="close-btn" onclick="closeModal('settings-modal')">&times;</div>
            <div class="egg-scroll-area" style="padding:20px;">
                <h2>設定</h2>
                <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
                    <button class="buy-btn" style="background:#3498db; border-color:#2980b9;" onclick="downloadSave()">
                        <i class="bi bi-download"></i> データをダウンロード
                    </button>
                    <label class="buy-btn" style="background:#e67e22; border-color:#d35400; display:block; cursor:pointer;">
                        <i class="bi bi-upload"></i> データをロード
                        <input type="file" style="display:none;" onchange="uploadSave(this)">
                    </label>
                    <hr style="width:100%; border-color:#eee;">
                    <button class="buy-btn" style="background:#e74c3c; border-color:#c0392b;" onclick="hardReset()">
                        <i class="bi bi-trash-fill"></i> データ削除
                    </button>
                </div>
                
                <div class="settings-info">
                    <h4>セーブデータについて</h4>
                    <p>データはブラウザの<b>localStorage</b>に自動保存されます。ブラウザのキャッシュを削除すると消える可能性があります。</p>
                    <p><b>ダウンロード</b>ボタンでバックアップを作成し、<b>ロード</b>でいつでも復元できます。</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ================= CONFIGURATION & CONSTANTS ================= */
        const GAME_VERSION = 7.0; 
        const ALPHABETS = "abcdefghijklmnopqrstuvwxyz";

        const RARITY_COLORS = {
            "Basic": "#b2bec3", "Rare": "#55efc4", "Epic": "#0984e3", "Legendary": "#fdcb6e",
            "Mythical": "#d63031", "Divine": "#e056fd", "Exclusive": "#6c5ce7", "Secret": "#000000",
            "Taco": "#f1c40f", "Potion": "#e84393", "Godly": "#ff0055", "Zenith": "#ffffff",
            "Void": "#4b0082", "Omega": "#ff4500", "Infinity": "#33ff33"
        };

        /* --- STRICTLY ENFORCED SUFFIX LIST --- */
        const SUFFIXES = [
            "", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc", "Ud", "Dd", "Td", "Qad", 
            "Qid", "Sxd", "Spd", "Ocd", "Nod", "Vg", "Uvg", "Dvg", "Tvg", "Qavg", "Qivg", "Sxvg", "Spvg", 
            "Ocvg", "Novg", "Tg", "Utg", "Dtg", "Ttg", "Qatg", "Qitg", "Sxtg", "Sptg", "Octg", "Notg", 
            "Qg", "Uqg", "Dqg", "Tqg", "Qaqg", "Qiqg", "Sxqg", "Spqg", "Ocqg", "Noqg", "Qqg", "Uqqg", 
            "Dqqg", "Tqqg", "Qaqqg", "Qiqqg", "Sxqqg", "Spqqg", "Ocqqg", "Noqqg", "Sg", "Usg", "Dsg", 
            "Tsg", "Qasg", "Qisg", "Sxsg", "Spsg", "Ocsg", "Nosg", "Stg", "Ustg", "Dstg", "Tstg", 
            "Qastg", "Qistg", "Sxstg", "Spstg", "Ocstg", "Nostg", "Og", "Uog", "Dog", "Tog", "Qaog", 
            "Qiog", "Sxog", "Spog", "Ocog", "Noog", "Ng", "Ung", "Dng", "Tng", "Qang", "Qing", "Sxng", 
            "Spng", "Ocng", "Nong", "Ce", "Uce"
        ];

        // NEW INFINITE FORMATTER WITH STRICT LIST & FALLBACK
        function formatNumber(num) {
            let d = new Decimal(num);
            if(d.lt(1000)) return d.floor().toString();
            
            let exponent = d.e; 
            let tier = Math.floor(exponent / 3);
            
            // Check if within our hardcoded list
            if (tier < SUFFIXES.length) {
                return d.div(Decimal.pow(10, tier * 3)).toFixed(2) + SUFFIXES[tier];
            }
            
            // Fallback logic for aa, ab... starting AFTER Uce (tier 102)
            // Uce is index 102 (10^306). Next is 10^309 (tier 103).
            let offset = tier - SUFFIXES.length; 
            let s = "";
            let r = offset;
            
            // Base 26 logic (a, b... z, aa, ab...)
            do {
                let rem = r % 26;
                s = ALPHABETS[rem] + s;
                r = Math.floor(r / 26) - 1; // -1 adjusts for 0-index overlap in multi-char
            } while (r >= 0);
            
            if (s.length < 2) s = "a" + s; // Force 2 chars if single? Optional but common style
            
            return d.div(Decimal.pow(10, tier * 3)).toFixed(2) + s;
        }

        function showNotification(msg, type) {
            let area = document.getElementById('notification-area');
            let el = document.createElement('div');
            el.className = 'custom-notif';
            let icon = type==='error' ? '<i class="bi bi-exclamation-triangle-fill" style="color:#e74c3c"></i>' : '<i class="bi bi-info-circle-fill" style="color:#3498db"></i>';
            if(type==='success') icon = '<i class="bi bi-check-circle-fill" style="color:#2ecc71"></i>';
            if(msg.includes('保存') || msg.includes('復元')) icon = '<i class="bi bi-floppy-fill" style="color:#2ecc71"></i>';
            el.innerHTML = `${icon} <span>${msg}</span>`;
            area.appendChild(el);
            setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); }, 3500);
        }

        /* ================= GAME DATA DEFINITIONS ================= */
        // COMPLETELY REBALANCED WORLD COSTS (Smoother Progression)
        // Music Links fixed to reliable HTTPS sources with correct encoding
        const WORLDS = [
            { id: 0, name: "オーバーワールド", multi: "1", cost: "0", bg: "linear-gradient(135deg, #00c6ff, #0072ff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Cipher2.mp3" },
            { id: 1, name: "キャンディランド", multi: "4", cost: "25000", bg: "linear-gradient(135deg, #ff9a9e, #fecfef)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Carefree.mp3" },
            { id: 2, name: "溶岩の領域", multi: "20", cost: "1e7", bg: "linear-gradient(135deg, #4b130f, #e74c3c)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Volatile%20Reaction.mp3" },
            { id: 3, name: "宇宙空間", multi: "100", cost: "5e9", bg: "linear-gradient(135deg, #000000, #434343)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Space%201990.mp3" },
            { id: 4, name: "タコスゾーン", multi: "500", cost: "1e13", bg: "linear-gradient(135deg, #f1c40f, #e67e22)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Chee%20Zee%20Jungle.mp3" },
            { id: 5, name: "サイバーシティ", multi: "2500", cost: "1e17", bg: "linear-gradient(135deg, #0f0c29, #302b63, #24243e)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Local%20Forecast%20-%20Elevator.mp3" },
            { id: 6, name: "アトランティス", multi: "1e4", cost: "1e22", bg: "linear-gradient(135deg, #00d2ff, #3a7bd5)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Lobby%20Time.mp3" },
            { id: 7, name: "天国の門", multi: "5e4", cost: "1e27", bg: "linear-gradient(135deg, #E0EAFC, #CFDEF3)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Wallpaper.mp3" },
            { id: 8, name: "暗黒のダンジョン", multi: "2e5", cost: "1e33", bg: "linear-gradient(135deg, #200122, #6f0000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Movement%20Proposition.mp3" },
            { id: 9, name: "銀河の核", multi: "1e6", cost: "1e40", bg: "radial-gradient(circle, #ff00cc, #333399)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Pixel%20Peeker%20Polka%20-%20slower.mp3" },
            { id: 10, name: "虚無の次元", multi: "5e6", cost: "1e48", bg: "linear-gradient(135deg, #000, #222)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Decisions.mp3" },
            { id: 11, name: "ネオン東京", multi: "2e7", cost: "1e56", bg: "linear-gradient(135deg, #ff00ff, #00ffff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Video%20Dungeon%20Boss.mp3" },
            { id: 12, name: "スチームパンク", multi: "1e8", cost: "1e65", bg: "linear-gradient(135deg, #b8860b, #8b4513)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Mechanolith.mp3" },
            { id: 13, name: "8ビット王国", multi: "5e8", cost: "1e74", bg: "linear-gradient(135deg, #74b9ff, #55efc4)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/8bit%20Dungeon%20Level.mp3" },
            { id: 14, name: "ドラゴンの巣", multi: "2e9", cost: "1e83", bg: "linear-gradient(135deg, #c0392b, #8e44ad)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Rite%20of%20Passage.mp3" },
            { id: 15, name: "忍の里", multi: "1e10", cost: "1e92", bg: "linear-gradient(135deg, #2d3436, #000000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Eastminster.mp3" },
            { id: 16, name: "ゴールドラッシュ", multi: "5e10", cost: "1e102", bg: "linear-gradient(135deg, #f1c40f, #f39c12)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Five%20Armies.mp3" },
            { id: 17, name: "お化け屋敷", multi: "2e11", cost: "1e112", bg: "linear-gradient(135deg, #2c3e50, #4b4b4b)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Amazing%20Plan.mp3" },
            { id: 18, name: "氷結ツンドラ", multi: "1e12", cost: "1e122", bg: "linear-gradient(135deg, #a29bfe, #74b9ff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Winter%20Reflections.mp3" },
            { id: 19, name: "砂漠の遺跡", multi: "5e12", cost: "1e133", bg: "linear-gradient(135deg, #e67e22, #d35400)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Impact%20Prelude.mp3" },
            { id: 20, name: "アマゾンジャングル", multi: "2e13", cost: "1e144", bg: "linear-gradient(135deg, #27ae60, #2ecc71)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Jungle%20of%20the%20Amazon.mp3" },
            { id: 21, name: "ユートピア3000", multi: "1e14", cost: "1e155", bg: "linear-gradient(135deg, #dfe6e9, #ffffff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Ethereal.mp3" },
            { id: 22, name: "ノワールシティ", multi: "5e14", cost: "1e166", bg: "linear-gradient(135deg, #2d3436, #636e72)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Sweeter%20Vermin.mp3" },
            { id: 23, name: "グリッチマトリックス", multi: "2e15", cost: "1e178", bg: "linear-gradient(135deg, #00ff00, #000000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Fluffing%20a%20Duck.mp3" },
            { id: 24, name: "サイバースラム", multi: "1e16", cost: "1e190", bg: "linear-gradient(135deg, #4b0082, #8b0000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Killing%20Time.mp3" },
            { id: 25, name: "天空の城ラピス", multi: "5e16", cost: "1e202", bg: "linear-gradient(135deg, #87ceeb, #f0f8ff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/On%20the%20Ground.mp3" },
            { id: 26, name: "深海トレンチ", multi: "2e17", cost: "1e215", bg: "linear-gradient(135deg, #00008b, #191970)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Water%20Prelude.mp3" },
            { id: 27, name: "マグマコア", multi: "1e18", cost: "1e228", bg: "linear-gradient(135deg, #ff4500, #8b0000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Volatile%20Reaction.mp3" },
            { id: 28, name: "古代ローマ", multi: "5e18", cost: "1e241", bg: "linear-gradient(135deg, #deb887, #f5f5dc)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Folk%20Round.mp3" },
            { id: 29, name: "ワイルドウェスト", multi: "2e19", cost: "1e254", bg: "linear-gradient(135deg, #d2691e, #8b4513)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Bama%20Country.mp3" },
            { id: 30, name: "ジュラシックパーク", multi: "1e20", cost: "1e267", bg: "linear-gradient(135deg, #228b22, #006400)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/River%20Valley%20Breakdown.mp3" },
            { id: 31, name: "ホラーマンション", multi: "5e20", cost: "1e280", bg: "linear-gradient(135deg, #2f4f4f, #000000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Day%20of%20Chaos.mp3" },
            { id: 32, name: "月面基地", multi: "2e21", cost: "1e293", bg: "linear-gradient(135deg, #d3d3d3, #708090)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Expeditionary.mp3" },
            { id: 33, name: "火星コロニー", multi: "1e22", cost: "1e305", bg: "linear-gradient(135deg, #ff6347, #8b0000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Red%20Letter.mp3" },
            { id: 34, name: "太陽の表面", multi: "5e22", cost: "1e318", bg: "linear-gradient(135deg, #ffd700, #ff8c00)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Hot%20Swing.mp3" },
            { id: 35, name: "ブラックホール事象", multi: "2e23", cost: "1e330", bg: "radial-gradient(circle, #000000, #4b0082)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Black%20Vortex.mp3" },
            { id: 36, name: "マルチバース", multi: "1e24", cost: "1e342", bg: "linear-gradient(135deg, #9400d3, #00ced1)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Ethereal.mp3" },
            { id: 37, name: "ピクセル次元", multi: "5e24", cost: "1e355", bg: "linear-gradient(135deg, #00ff00, #ff00ff)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/8bit%20Dungeon%20Level.mp3" },
            { id: 38, name: "抽象芸術の世界", multi: "2e25", cost: "1e368", bg: "linear-gradient(135deg, #ff69b4, #ffff00)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Monkeys%20Spinning%20Monkeys.mp3" },
            { id: 39, name: "ホワイトスペース", multi: "1e26", cost: "1e380", bg: "linear-gradient(135deg, #ffffff, #f0f0f0)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Clean%20Soul.mp3" },
            { id: 40, name: "シンギュラリティ", multi: "1e27", cost: "1e392", bg: "radial-gradient(circle, #ffffff, #000000)", music: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Universal.mp3" }
        ];

        const EGGS = [
            { id: 0, name: "スターター卵", cost: "250", pets: [{ name: "イヌ", rarity: "Basic", chance: 0.6, power: 1.5 }, { name: "ネコ", rarity: "Basic", chance: 0.35, power: 2 }, { name: "ウサギ", rarity: "Rare", chance: 0.05, power: 5 }] },
            { id: 1, name: "森の卵", cost: "15000", pets: [{ name: "クマ", rarity: "Rare", chance: 0.7, power: 15 }, { name: "キツネ", rarity: "Epic", chance: 0.25, power: 40 }, { name: "ドラゴン", rarity: "Legendary", chance: 0.05, power: 150 }] },
            { id: 2, name: "マグマの卵", cost: "5e6", pets: [{ name: "インプ", rarity: "Epic", chance: 0.6, power: 300 }, { name: "ゴーレム", rarity: "Mythical", chance: 0.35, power: 800 }, { name: "フェニックス", rarity: "Divine", chance: 0.05, power: 5000 }] },
            { id: 3, name: "虚無の卵", cost: "2e9", pets: [{ name: "エイリアン", rarity: "Mythical", chance: 0.7, power: 10000 }, { name: "UFO", rarity: "Divine", chance: 0.29, power: 30000 }, { name: "ブラックホール", rarity: "Exclusive", chance: 0.01, power: 200000 }] },
            { id: 4, name: "タコスの卵", cost: "5e14", pets: [{ name: "タコス", rarity: "Legendary", chance: 0.8, power: 1e5 }, { name: "ブリトー", rarity: "Mythical", chance: 0.19, power: 5e5 }, { name: "ゴールデンタコス", rarity: "Exclusive", chance: 0.01, power: 2e6 }] },
            { id: 5, name: "サイバー卵", cost: "1e16", pets: [{ name: "ロボット", rarity: "Legendary", chance: 0.8, power: 5e6 }, { name: "サイボーグ", rarity: "Mythical", chance: 0.19, power: 2e7 }, { name: "AIの神", rarity: "Exclusive", chance: 0.01, power: 1e8 }] },
            { id: 6, name: "海の卵", cost: "1e20", pets: [{ name: "サメ", rarity: "Mythical", chance: 0.8, power: 1e9 }, { name: "クラーケン", rarity: "Divine", chance: 0.19, power: 5e9 }, { name: "リヴァイアサン", rarity: "Exclusive", chance: 0.01, power: 5e10 }] },
            { id: 7, name: "天界の卵", cost: "1e25", pets: [{ name: "エンジェル", rarity: "Divine", chance: 0.8, power: 1e12 }, { name: "アークエンジェル", rarity: "Exclusive", chance: 0.19, power: 1e13 }, { name: "創造主", rarity: "Secret", chance: 0.01, power: 1e15 }] },
            { id: 8, name: "悪魔の卵", cost: "1e30", pets: [{ name: "小悪魔", rarity: "Divine", chance: 0.8, power: 1e16 }, { name: "デーモンロード", rarity: "Exclusive", chance: 0.19, power: 1e18 }, { name: "サタン", rarity: "Secret", chance: 0.01, power: 1e20 }] },
            { id: 9, name: "銀河の卵", cost: "1e38", pets: [{ name: "スター", rarity: "Divine", chance: 0.8, power: 1e24 }, { name: "パルサー", rarity: "Exclusive", chance: 0.19, power: 1e26 }, { name: "クエーサー", rarity: "Secret", chance: 0.01, power: 1e28 }] },
            { id: 10, name: "次元の卵", cost: "1e45", pets: [{ name: "次元の裂け目", rarity: "Exclusive", chance: 0.8, power: 1e32 }, { name: "時空の支配者", rarity: "Secret", chance: 0.19, power: 1e35 }, { name: "THE END", rarity: "Taco", chance: 0.01, power: 1e40 }] },
            { id: 11, name: "ネオン卵", cost: "1e52", pets: [{ name: "ネオンキャット", rarity: "Exclusive", chance: 0.8, power: 1e45 }, { name: "サイバーパンク", rarity: "Secret", chance: 0.19, power: 1e50 }, { name: "AKIRA", rarity: "Taco", chance: 0.01, power: 1e55 }] },
            { id: 12, name: "歯車の卵", cost: "1e60", pets: [{ name: "歯車", rarity: "Rare", chance: 0.8, power: 1e60 }, { name: "蒸気機関", rarity: "Legendary", chance: 0.19, power: 1e65 }, { name: "タイムギア", rarity: "Secret", chance: 0.01, power: 1e70 }] },
            { id: 13, name: "ドットの卵", cost: "1e70", pets: [{ name: "スライム", rarity: "Rare", chance: 0.8, power: 1e80 }, { name: "勇者", rarity: "Mythical", chance: 0.19, power: 1e85 }, { name: "魔王", rarity: "Secret", chance: 0.01, power: 1e90 }] },
            { id: 14, name: "竜の卵", cost: "1e80", pets: [{ name: "ワイバーン", rarity: "Epic", chance: 0.8, power: 1e100 }, { name: "古龍", rarity: "Divine", chance: 0.19, power: 1e110 }, { name: "バハムート", rarity: "Taco", chance: 0.01, power: 1e120 }] },
            { id: 15, name: "黄金の卵", cost: "1e90", pets: [{ name: "金塊", rarity: "Legendary", chance: 0.8, power: 1e140 }, { name: "トレジャー", rarity: "Exclusive", chance: 0.19, power: 1e150 }, { name: "ミダス", rarity: "Secret", chance: 0.01, power: 1e160 }] },
            { id: 16, name: "氷の卵", cost: "1e100", pets: [{ name: "雪だるま", rarity: "Mythical", chance: 0.8, power: 1e180 }, { name: "イエティ", rarity: "Divine", chance: 0.19, power: 1e200 }, { name: "氷の女王", rarity: "Taco", chance: 0.01, power: 1e220 }] },
            { id: 17, name: "未来の卵", cost: "1e115", pets: [{ name: "ドローン", rarity: "Divine", chance: 0.8, power: 1e250 }, { name: "アンドロイド", rarity: "Exclusive", chance: 0.19, power: 1e270 }, { name: "ニューラルAI", rarity: "Secret", chance: 0.01, power: 1e300 }] },
            { id: 18, name: "古代の卵", cost: "1e150", pets: [{ name: "化石", rarity: "Divine", chance: 0.8, power: 1e350 }, { name: "アンモナイト", rarity: "Exclusive", chance: 0.19, power: 1e380 }, { name: "シーラカンス", rarity: "Secret", chance: 0.01, power: 1e400 }] },
            { id: 19, name: "密林の卵", cost: "1e200", pets: [{ name: "ジャガー", rarity: "Exclusive", chance: 0.8, power: 1e450 }, { name: "大蛇", rarity: "Secret", chance: 0.19, power: 1e480 }, { name: "森の精霊", rarity: "Godly", chance: 0.01, power: 1e500 }] },
            { id: 20, name: "スラムの卵", cost: "1e230", pets: [{ name: "ラット", rarity: "Exclusive", chance: 0.8, power: 1e550 }, { name: "ハッカー", rarity: "Secret", chance: 0.19, power: 1e600 }, { name: "ジャンク神", rarity: "Zenith", chance: 0.01, power: 1e650 }] },
            { id: 21, name: "天空の卵", cost: "1e250", pets: [{ name: "ハーピー", rarity: "Secret", chance: 0.8, power: 1e700 }, { name: "グリフォン", rarity: "Godly", chance: 0.19, power: 1e750 }, { name: "天空竜", rarity: "Zenith", chance: 0.01, power: 1e800 }] },
            { id: 22, name: "深海の卵", cost: "1e275", pets: [{ name: "アンコウ", rarity: "Secret", chance: 0.8, power: 1e850 }, { name: "海獣", rarity: "Godly", chance: 0.19, power: 1e900 }, { name: "ポセイドン", rarity: "Zenith", chance: 0.01, power: 1e1000 }] },
            { id: 23, name: "溶岩核の卵", cost: "1e300", pets: [{ name: "溶岩スライム", rarity: "Godly", chance: 0.8, power: 1e1100 }, { name: "イフリート", rarity: "Zenith", chance: 0.19, power: 1e1200 }, { name: "スルト", rarity: "Void", chance: 0.01, power: 1e1300 }] },
            { id: 24, name: "ローマの卵", cost: "1e310", pets: [{ name: "戦士", rarity: "Godly", chance: 0.8, power: 1e1400 }, { name: "将軍", rarity: "Zenith", chance: 0.19, power: 1e1500 }, { name: "カエサル", rarity: "Void", chance: 0.01, power: 1e1600 }] },
            { id: 25, name: "西部の卵", cost: "1e340", pets: [{ name: "保安官", rarity: "Zenith", chance: 0.8, power: 1e1700 }, { name: "無法者", rarity: "Void", chance: 0.19, power: 1e1800 }, { name: "早撃ち", rarity: "Omega", chance: 0.01, power: 1e2000 }] },
            { id: 26, name: "恐竜の卵", cost: "1e370", pets: [{ name: "トリケラ", rarity: "Zenith", chance: 0.8, power: 1e2200 }, { name: "T-Rex", rarity: "Void", chance: 0.19, power: 1e2400 }, { name: "メテオ", rarity: "Omega", chance: 0.01, power: 1e2600 }] },
            { id: 27, name: "恐怖の卵", cost: "1e410", pets: [{ name: "ゴースト", rarity: "Void", chance: 0.8, power: 1e2800 }, { name: "死神", rarity: "Omega", chance: 0.19, power: 1e3000 }, { name: "クトゥルフ", rarity: "Omega", chance: 0.01, power: 1e3200 }] },
            { id: 28, name: "月の卵", cost: "1e460", pets: [{ name: "ムーンラビット", rarity: "Void", chance: 0.8, power: 1e3500 }, { name: "かぐや", rarity: "Omega", chance: 0.19, power: 1e3800 }, { name: "月読命", rarity: "Omega", chance: 0.01, power: 1e4000 }] },
            { id: 29, name: "火星の卵", cost: "1e510", pets: [{ name: "マーズ", rarity: "Void", chance: 0.8, power: 1e4500 }, { name: "火星人", rarity: "Omega", chance: 0.19, power: 1e5000 }, { name: "オリンポス", rarity: "Omega", chance: 0.01, power: 1e5500 }] },
            { id: 30, name: "太陽の卵", cost: "1e610", pets: [{ name: "フレア", rarity: "Omega", chance: 0.8, power: 1e6000 }, { name: "ヘリオス", rarity: "Omega", chance: 0.19, power: 1e6500 }, { name: "アマテラス", rarity: "Omega", chance: 0.01, power: 1e7000 }] },
            { id: 31, name: "ブラックホール卵", cost: "1e760", pets: [{ name: "重力子", rarity: "Omega", chance: 0.8, power: 1e8000 }, { name: "事象の地平線", rarity: "Omega", chance: 0.19, power: 1e9000 }, { name: "特異点", rarity: "Omega", chance: 0.01, power: 1e10000 }] },
            { id: 32, name: "マルチバース卵", cost: "1e920", pets: [{ name: "別次元の君", rarity: "Omega", chance: 0.8, power: 1e12000 }, { name: "タイムパトロール", rarity: "Omega", chance: 0.19, power: 1e14000 }, { name: "全知全能", rarity: "Omega", chance: 0.01, power: 1e16000 }] },
            { id: 33, name: "ピクセル卵", cost: "1e1150", pets: [{ name: "バグ", rarity: "Omega", chance: 0.8, power: 1e18000 }, { name: "グリッチ", rarity: "Omega", chance: 0.19, power: 1e20000 }, { name: "開発者", rarity: "Omega", chance: 0.01, power: 1e25000 }] },
            { id: 34, name: "抽象の卵", cost: "1e1550", pets: [{ name: "形", rarity: "Omega", chance: 0.8, power: 1e30000 }, { name: "色", rarity: "Omega", chance: 0.19, power: 1e35000 }, { name: "概念", rarity: "Omega", chance: 0.01, power: 1e40000 }] },
            { id: 35, name: "無の卵", cost: "1e2100", pets: [{ name: "空白", rarity: "Omega", chance: 0.8, power: 1e50000 }, { name: "虚構", rarity: "Omega", chance: 0.19, power: 1e60000 }, { name: "存在しないもの", rarity: "Omega", chance: 0.01, power: 1e80000 }] },
            { id: 36, name: "シンギュラリティ卵", cost: "1e3100", pets: [{ name: "AI", rarity: "Omega", chance: 0.8, power: 1e100000 }, { name: "超知能", rarity: "Omega", chance: 0.19, power: 1e200000 }, { name: "THE END", rarity: "Zenith", chance: 0.01, power: 1e500000 }] }
        ];

        const DIAMOND_SHOP = [
            { id: 'speed_potion', name: 'スピードポーション', desc:'5分間クリック2倍', cost: 50, type: 'buff', duration: 300, icon:'bi-lightning-fill', rarity:'Potion' },
            { id: 'luck_potion', name: 'ラックポーション', desc:'5分間ダイヤ出現率2倍', cost: 100, type: 'buff', duration: 300, icon:'bi-stars', rarity:'Potion' },
            { id: 'crit_potion', name: '会心ポーション', desc:'5分間クリティカル率2倍', cost: 150, type: 'buff', duration: 300, icon:'bi-bullseye', rarity:'Potion' },
            { id: 'gold_potion', name: 'ゴールドポーション', desc:'5分間ゴールド獲得2倍', cost: 200, type: 'buff', duration: 300, icon:'bi-coin', rarity:'Potion' },
            { id: 'click_frenzy', name: 'クリックフレンジー', desc:'3分間クリックパワー5倍', cost: 500, type: 'buff', duration: 180, icon:'bi-cursor-fill', rarity:'Epic' },
            { id: 'ultra_luck', name: 'ウルトララック', desc:'3分間ダイヤ出現率5倍', cost: 750, type: 'buff', duration: 180, icon:'bi-gem', rarity:'Legendary' },
            { id: 'mega_potion', name: 'メガポーション', desc:'2分間 全ステータス3倍', cost: 1500, type: 'buff', duration: 120, icon:'bi-fire', rarity:'Godly' },
            { id: 'god_potion', name: '神のポーション', desc:'1分間 全ステータス10倍', cost: 10000, type: 'buff', duration: 60, icon:'bi-sun-fill', rarity:'Zenith' },
            
            // NERFED HIGHER TIER ITEMS (To prevent infinite loops/stops)
            { id: 'hyper_god_potion', name: 'ハイパーゴッド', desc:'1分間 全ステータス20倍', cost: 500000, type: 'buff', duration: 60, icon:'bi-tsunami', rarity:'Void' },
            { id: 'universe_breaker', name: '宇宙の破壊者', desc:'30秒間 全ステータス100倍', cost: 10000000, type: 'buff', duration: 30, icon:'bi-infinity', rarity:'Omega' },
            { id: 'infinite_void', name: '無限の虚無', desc:'10秒間 全ステータス5000倍', cost: 1000000000, type: 'buff', duration: 10, icon:'bi-eye-fill', rarity:'Infinity' },

            { id: 'perm_click', name: '永続クリック強化', desc:'クリック力永久+100%', cost: 1000000, type: 'perm', power: 2, icon:'bi-mouse', rarity:'Exclusive' },
            { id: 'perm_auto', name: '永続自動強化', desc:'自動クリック永久+100%', cost: 5000000, type: 'perm', power: 2, icon:'bi-robot', rarity:'Secret' },
            { id: 'perm_luck', name: '永続ラック強化', desc:'ダイヤ出現率永久+100%', cost: 100000000, type: 'perm', power: 2, icon:'bi-stars', rarity:'Godly' },
            
            { id: 'exclusive_egg', name: 'Exclusive Egg', desc:'限定ペット確定 (1e10倍)', cost: 5000, type: 'pet', power: 1e10, rarity:'Exclusive', icon:'bi-egg-fill' },
            { id: 'secret_egg', name: 'Secret Egg', desc:'？？？ (1e15倍)', cost: 25000, type: 'pet', power: 1e15, rarity:'Secret', icon:'bi-question-circle-fill' },
            { id: 'zenith_egg', name: 'Zenith Egg', desc:'究極ペット (1e50倍)', cost: 1000000000, type: 'pet', power: 1e50, rarity:'Zenith', icon:'bi-trophy-fill' },
            // NEW PET ITEM
            { id: 'dev_egg', name: '開発者エッグ', desc:'チート級ペット (1e100倍)', cost: 1e15, type: 'pet', power: 1e100, rarity:'Infinity', icon:'bi-code-square' }
        ];

        const UPGRADE_NAMES = [
            ["木のカーソル", "グランマ", "農場", "宝石磨き", "四つ葉のクローバー"], // World 0
            ["工場", "砂糖のマウス", "銀のコイン", "お菓子オーブン", "魔法のシュガー"], // World 1
            ["寺院", "黒曜石マウス", "魔法使いの塔", "金の延べ棒", "マグマクリスタル"], // World 2
            ["宇宙船", "スペースマウス", "錬金術ラボ", "メテオマイナー", "エイリアンアーティファクト"], // World 3
            ["ポータル", "金のタコス", "タイムマシン", "サルサカーソル", "激辛ソース"], // World 4
            ["反物質凝縮器", "レーザーポインタ", "プリズム", "ビットコイン採掘", "量子チップ"], // World 5
            ["チャンセリー", "トライデント", "パールダイバー", "水素発電機", "深海の真珠"], // World 6
            ["フラクタルエンジン", "天使の輪", "天使の羽", "雲の宮殿", "聖なる杯"], // World 7
            ["JSコンソール", "悪魔の爪", "地獄の穴", "悪魔の契約", "呪いの指輪"], // World 8
            ["皮質ベイカー", "プラズマガン", "スターフォージ", "ブラックホール", "ダークマター"], // World 9
            ["ヴォイドウォーカー", "Nullポインタ", "虚無の宝箱", "リアリティエンジン", "虚空の瞳"], // World 10
            ["ネオン広告", "サイバー刀", "仮想通貨銀行", "ホロアイドル", "電脳ドラッグ"], // World 11
            ["蒸気機関", "真鍮のゴーグル", "クロックワーク", "スチームドリル", "黄金の歯車"], // World 12
            ["ドット絵勇者", "ピクセル剣", "グリッチ発生装置", "チートコード", "隠しブロック"], // World 13
            ["ドラゴンの鱗", "炎の息吹", "ワイバーンの巣", "宝の守り手", "竜の涙"], // World 14
            ["手裏剣工場", "苦無", "影分身の術", "忍びの極意", "秘伝の巻物"], // World 15
            ["巨大ツルハシ", "選鉱鍋", "造幣局", "銀行強盗", "巨大ダイヤモンド"], // World 16
            ["エクトプラズム", "ウィジャ盤", "ポルターガイスト", "呪われた人形", "霊魂のランタン"], // World 17
            ["氷柱", "イグルー村", "冷凍睡眠装置", "イエティの毛皮", "永久凍土の欠片"], // World 18
            ["砂のシャベル", "ピラミッドパワー", "スフィンクス", "オアシス", "ファラオの仮面"], // World 19
            ["マチェーテ", "ツリーハウス", "古代遺跡", "ジャングルの秘宝", "黄金の果実"], // World 20
            ["ホバーボード", "ナノボット", "核融合炉", "空中都市", "反重力ブーツ"], // World 21
            ["探偵バッジ", "タイプライター", "ジャズクラブ", "街灯", "機密ファイル"], // World 22
            ["赤い薬", "コードの雨", "アーキテクト", "システムコア", "バグ報告書"], // World 23
            // New Worlds
            ["ジャンクアーム", "データ商人", "スラムの王", "違法改造", "違法チップ"], // 24 Cyber Slum
            ["浮遊石", "飛空艇", "風の神殿", "天空の財宝", "天空の羅針盤"], // 25 Sky Castle
            ["潜水艇", "深海生物", "海底都市", "沈没船の宝", "古代のスクロール"], // 26 Deep Sea
            ["マグマドリル", "耐熱スーツ", "地熱発電所", "炎の精霊", "コアの破片"], // 27 Magma
            ["コロッセオ", "剣闘士", "水道橋", "皇帝の金貨", "勝者の月桂冠"], // 28 Rome
            ["リボルバー", "保安官", "砂金採り", "酒場", "保安官のバッジ"], // 29 Wild West
            ["琥珀の杖", "恐竜の卵", "遺伝子ラボ", "T-REX", "琥珀の蚊"], // 30 Jurassic
            ["チェーンソー", "ゾンビ", "廃病院", "血の契約", "血塗られた鍵"], // 31 Horror
            ["月面車", "クレーター", "ヘリウム3", "エイリアンの遺跡", "月の石"], // 32 Moon
            ["テラフォーミング", "赤い砂", "バイオドーム", "火星人", "赤い宝石"], // 33 Mars
            ["ソーラーパネル", "核融合", "プラズマ", "太陽神", "太陽の雫"], // 34 Sun
            ["事象の地平線", "重力レンズ", "特異点", "時間停止", "重力特異点"], // 35 Black Hole
            ["次元跳躍", "パラレルワールド", "ドッペルゲンガー", "多元宇宙論", "平行世界の地図"], // 36 Multiverse
            ["ボクセル", "3Dプリンタ", "レンダリング", "ポリゴン", "レアピクセル"], // 37 Pixel
            ["シュルレアリスム", "ダリの時計", "キュビズム", "色彩の暴力", "歪んだ時計"], // 38 Abstract
            ["無", "空白", "消しゴム", "再構築", "無限のインク"], // 39 White Space
            ["AIの反乱", "意識のアップロード", "永遠の命", "オメガポイント", "神の意識"] // 40 Singularity
        ];

        /* ================= GAME LOGIC START ================= */
        const BUILDING_TYPES = [];
        let upgradeIdCounter = 1;
        WORLDS.forEach((w, idx) => {
            if(idx < UPGRADE_NAMES.length) {
                let names = UPGRADE_NAMES[idx];
                // Balanced Costs: Smoother scaling per world
                let baseCost = new Decimal(w.cost).eq(0) ? new Decimal(15) : new Decimal(w.cost).times(1.5);
                let baseProd = new Decimal(w.multi).times(4); // Increased base power to match cost scaling
                
                BUILDING_TYPES.push({ id: `u${upgradeIdCounter++}`, name: names[0], type: 'click', baseP: baseProd, baseC: baseCost, icon: 'bi-cursor', desc: `クリックパワー +${formatNumber(baseProd)}`, worldReq: idx });
                BUILDING_TYPES.push({ id: `u${upgradeIdCounter++}`, name: names[1], type: 'auto', baseP: baseProd.times(3), baseC: baseCost.times(15), icon: 'bi-gear', desc: `自動クリック +${formatNumber(baseProd.times(3))}`, worldReq: idx });
                BUILDING_TYPES.push({ id: `u${upgradeIdCounter++}`, name: names[2], type: 'auto', baseP: baseProd.times(12), baseC: baseCost.times(150), icon: 'bi-buildings', desc: `自動クリック +${formatNumber(baseProd.times(12))}`, worldReq: idx });
                
                // 4th Upgrade: Diamond/Gold Multiplier
                let type = idx % 2 === 0 ? 'diamond' : 'gold';
                let desc = "";
                let val = new Decimal(0);
                if (type === 'diamond') {
                    val = new Decimal(0.5).times(idx + 1); 
                    desc = `ダイヤ獲得量 +${val.toNumber().toFixed(1)}`;
                } else {
                    val = new Decimal(0.1); 
                    desc = `ゴールド倍率 +10%`;
                }
                BUILDING_TYPES.push({ id: `u${upgradeIdCounter++}`, name: names[3], type: type, baseP: val, baseC: baseCost.times(500), icon: 'bi-stars', desc: desc, worldReq: idx });

                // 5th Upgrade: CHANCE UPGRADES
                let type5 = idx % 2 === 0 ? 'diamond_chance' : 'crit_chance';
                let desc5 = "";
                let val5 = new Decimal(0);
                if (type5 === 'diamond_chance') {
                    val5 = new Decimal(0.0005); 
                    desc5 = `ダイヤ出現確率 +0.05%`;
                } else {
                    val5 = new Decimal(0.005); 
                    desc5 = `会心率(ゴールド確率) +0.5%`;
                }
                BUILDING_TYPES.push({ id: `u${upgradeIdCounter++}`, name: names[4], type: type5, baseP: val5, baseC: baseCost.times(2000), icon: 'bi-magic', desc: desc5, worldReq: idx });
            }
        });

        let game = {
            version: GAME_VERSION,
            clicks: new Decimal(0), 
            gems: new Decimal(0),
            rebirths: 0,
            world: 0,
            buildings: {}, 
            inventory: [],
            buffs: {},
            permBuffs: { click: 0, auto: 0, luck: 0 },
            startTime: Date.now()
        };

        let buyMode = 1;
        let eggBuyAmount = 1;
        let autoHatchEnabled = false;
        let autoHatchTimer = null;
        let audioPlayer = document.getElementById('bgm-player');
        let currentEgg = null;
        
        // Cache Stats
        let cachedAutoCPS = new Decimal(0);
        let cachedClickPower = new Decimal(1);
        let cachedGoldMulti = new Decimal(1);
        let cachedDiamondMulti = new Decimal(1);
        let cachedDiamondChance = 0.001;
        let cachedCritChance = 0.01;
        let manualClickHistory = [];

        window.onload = function() { initGame(); };

        function initGame() {
            loadGame(); 
            recalcStats();
            renderUpgrades(); renderEggs(); renderShop(); renderWorlds(); renderInventory();
            
            // Loop runs every 10ms (100FPS cap) for smoother performance but accurate math
            setInterval(gameLoop, 10); 
            setInterval(saveGame, 15000); 
            setInterval(recalcStats, 500); 
            
            document.body.addEventListener('click', () => { if(audioPlayer.paused && audioPlayer.src) audioPlayer.play().catch(()=>{}); }, {once:true});
            changeWorld(game.world, true);
        }

        function gameLoop() {
            let now = Date.now();
            
            // Add Auto Clicks (10ms worth = CPS / 100)
            if(cachedAutoCPS.gt(0)) {
                let add = cachedAutoCPS.div(100); 
                game.clicks = game.clicks.add(add);
            }
            
            // Buffs decay
            for(let key in game.buffs) {
                if(game.buffs[key] > 0) {
                    game.buffs[key] -= 0.01; 
                    if(game.buffs[key] <= 0) {
                         delete game.buffs[key];
                         recalcStats();
                    }
                }
            }

            // Progress Bar Logic
            updateProgressBar();

            manualClickHistory = manualClickHistory.filter(t => now - t < 1000);
            updateUI(cachedAutoCPS, manualClickHistory.length);
        }

        /* --- FIXED CALCULATIONS --- */
        function recalcStats() {
            let totalAuto = new Decimal(0);
            let totalClick = new Decimal(1);
            let goldMulti = new Decimal(1);
            let diamondMulti = new Decimal(1); // Base drop amount
            let diamondChance = 0.001; // Base 0.1% chance
            let critChance = 0.01; // Base 1% Crit
            
            // Global Multipliers
            let globalMulti = getTotalMulti(); // World * Pets * Rebirth

            BUILDING_TYPES.forEach(b => {
                let lvl = game.buildings[b.id] || 0;
                if(lvl > 0) {
                    if(b.type === 'click') { 
                        totalClick = totalClick.add(b.baseP.times(lvl)); 
                    } 
                    else if (b.type === 'auto') { 
                        totalAuto = totalAuto.add(b.baseP.times(lvl)); 
                    } 
                    else if (b.type === 'gold') { 
                        goldMulti = goldMulti.add(b.baseP.times(lvl)); 
                    } 
                    else if (b.type === 'diamond') {
                         diamondMulti = diamondMulti.add(b.baseP.times(lvl));
                    }
                    else if (b.type === 'diamond_chance') {
                        diamondChance += (b.baseP.toNumber() * lvl);
                    }
                    else if (b.type === 'crit_chance') {
                        critChance += (b.baseP.toNumber() * lvl);
                    }
                }
            });
            
            // Perm Buffs
            if(game.permBuffs) {
                totalClick = totalClick.times(1 + game.permBuffs.click);
                totalAuto = totalAuto.times(1 + game.permBuffs.auto);
                diamondChance *= (1 + game.permBuffs.luck);
            }

            // Buffs
            if(game.buffs['speed_potion']) totalClick = totalClick.times(2);
            if(game.buffs['luck_potion']) diamondChance *= 2;
            if(game.buffs['crit_potion']) critChance *= 2;
            if(game.buffs['gold_potion']) goldMulti = goldMulti.times(2);
            
            if(game.buffs['click_frenzy']) totalClick = totalClick.times(5);
            if(game.buffs['ultra_luck']) diamondChance *= 5;
            if(game.buffs['mega_potion']) {
                totalClick = totalClick.times(3); totalAuto = totalAuto.times(3); goldMulti = goldMulti.times(3); diamondMulti = diamondMulti.times(3); diamondChance *= 3;
            }
            if(game.buffs['god_potion']) {
                totalClick = totalClick.times(10); totalAuto = totalAuto.times(10); goldMulti = goldMulti.times(10); diamondMulti = diamondMulti.times(10); diamondChance *= 10;
            }
            // ADJUSTED HIGH TIER BUFFS
            if(game.buffs['hyper_god_potion']) {
                totalClick = totalClick.times(20); totalAuto = totalAuto.times(20); goldMulti = goldMulti.times(20); diamondMulti = diamondMulti.times(20); diamondChance *= 20;
            }
            if(game.buffs['universe_breaker']) {
                totalClick = totalClick.times(100); totalAuto = totalAuto.times(100); goldMulti = goldMulti.times(100); diamondMulti = diamondMulti.times(100); diamondChance *= 100;
            }
            if(game.buffs['infinite_void']) {
                totalClick = totalClick.times(5000); totalAuto = totalAuto.times(5000);
            }

            // Final Calculations
            // Auto CPS = (Sum of Buildings) * Global Multi * Gold Multi (Assuming Gold Multi acts as general profit multi)
            cachedAutoCPS = totalAuto.times(globalMulti).times(goldMulti); 
            cachedClickPower = totalClick.times(globalMulti).times(goldMulti);
            
            cachedGoldMulti = goldMulti;
            cachedDiamondMulti = diamondMulti;
            cachedDiamondChance = diamondChance;
            cachedCritChance = critChance;
            
            updateBuffDisplay();
        }

        function getTotalMulti() {
            let m = new Decimal(WORLDS[game.world].multi);
            let pMulti = new Decimal(1);
            let equipped = game.inventory.filter(p => p.equipped).sort((a,b)=>b.power-a.power).slice(0,5);
            equipped.forEach(p => pMulti = pMulti.add(p.power));
            let rMulti = new Decimal(1 + game.rebirths); 
            return m.times(pMulti).times(rMulti);
        }

        /* --- BULK COST (BALANCED) --- */
        // Scaling factor 1.18 is good for standard clicker games
        function getSingleCost(bObj, currentLvl) { return bObj.baseC.times(Decimal.pow(1.18, currentLvl)).floor(); }
        
        function getBulkCost(bObj, startLvl, count) {
            let r = 1.18;
            let a = bObj.baseC.times(Decimal.pow(r, startLvl));
            let num = Decimal.pow(r, count).sub(1);
            let den = r - 1;
            return a.times(num).div(den).floor();
        }
        
        function getMaxBuyable(bObj, startLvl, money) {
            let r = 1.18;
            let a = bObj.baseC.times(Decimal.pow(r, startLvl));
            if (money.lt(a)) return 0;
            let term = money.times(r-1).div(a).add(1);
            let n = term.log(r);
            return Math.floor(n);
        }

        function setBuyMode(val) {
            buyMode = val;
            document.querySelectorAll('.bulk-btn').forEach(b => b.classList.remove('active'));
            if(val===1) document.querySelectorAll('.bulk-btn')[0].classList.add('active');
            else if(val===10) document.querySelectorAll('.bulk-btn')[1].classList.add('active');
            else if(val===100) document.querySelectorAll('.bulk-btn')[2].classList.add('active');
            else document.querySelectorAll('.bulk-btn')[3].classList.add('active');
            document.getElementById('buy-amount-display').innerText = val === 'max' ? "MAX" : val;
            if(val !== 'max') {
                document.querySelector('.bulk-slider').value = val;
                document.querySelector('.bulk-input').value = val;
            }
            renderUpgrades(); 
        }
        function updateBulkSlider(val) { setBuyMode(parseInt(val)); }
        function updateBulkInput(val) { let v = parseInt(val); if(v<1)v=1; setBuyMode(v); }

        /* --- INTERACTION --- */
        document.getElementById('click-btn').addEventListener('pointerdown', (e) => {
            e.preventDefault();
            manualClickHistory.push(Date.now());
            let power = cachedClickPower;
            let isCrit = Math.random() < cachedCritChance;
            if(isCrit) power = power.times(2);
            game.clicks = game.clicks.add(power);
            
            spawnText(e.clientX, e.clientY, `+${formatNumber(power)}`, isCrit);
            
            // Diamond Drop Logic
            let dropCount = 0;
            if(cachedDiamondChance <= 1) {
                if(Math.random() < cachedDiamondChance) dropCount = 1;
            } else {
                dropCount = Math.floor(cachedDiamondChance);
                if(Math.random() < (cachedDiamondChance % 1)) dropCount++;
            }
            
            if(dropCount > 0) {
                let gemGain = cachedDiamondMulti.times(dropCount);
                game.gems = game.gems.add(gemGain);
                spawnText(e.clientX, e.clientY - 60, `+${formatNumber(gemGain)} ダイヤ!`, false, "#00d2ff");
            }
            
            let btn = document.getElementById('click-btn');
            btn.style.transform = "scale(0.95)";
            setTimeout(() => btn.style.transform = "scale(1)", 50);
            updateUI(cachedAutoCPS, manualClickHistory.length);
        });

        function spawnText(x, y, txt, crit, col) {
            let el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = txt + (crit?"!":"");
            el.style.color = col ? col : (crit ? "#f1c40f" : "white");
            if(crit || col) el.style.fontSize = "2rem";
            if(col) el.style.textShadow = `0 0 10px ${col}`;
            let rx = (Math.random()*40)-20;
            el.style.left = (x+rx)+"px"; el.style.top = y+"px";
            el.style.setProperty('--rot', (Math.random()*20-10)+'deg');
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 800);
        }

        /* --- UI UPDATER --- */
        function updateUI(autoCPS, manualCPS) {
            document.getElementById('disp-clicks').innerText = formatNumber(game.clicks);
            document.getElementById('disp-gems').innerText = formatNumber(game.gems);
            document.getElementById('disp-rebirths').innerText = game.rebirths;
            document.getElementById('disp-rebirth-multi').innerText = "x" + formatNumber(1 + game.rebirths);
            if(autoCPS !== undefined) document.getElementById('auto-cps').innerText = formatNumber(autoCPS);
            if(manualCPS !== undefined) document.getElementById('manual-cps').innerText = manualCPS;

            document.getElementById('total-pet-count').innerText = game.inventory.length;

            let rCost = new Decimal(5e7).times(Decimal.pow(15, game.rebirths)); 
            if(document.getElementById('rebirth-modal').style.display === 'flex') {
                document.getElementById('rebirth-cost-final').innerText = formatNumber(rCost) + " Clicks";
                let pct = game.clicks.div(rCost).times(100).toNumber();
                if(pct > 100) pct = 100;
                let circle = document.getElementById('rebirth-progress-circle');
                let circumference = 628; 
                let offset = circumference - (pct / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                document.getElementById('rebirth-progress-text').innerText = Math.floor(pct) + "%";
                document.getElementById('rebirth-reward-display').innerText = `+100% 永続倍率 (現在: x${1+game.rebirths})`;
                let rBtn = document.getElementById('rebirth-execute-btn');
                rBtn.disabled = game.clicks.lt(rCost);
            }

            document.querySelectorAll('.upgrade-buy-btn').forEach(btn => { 
                let cost = new Decimal(btn.dataset.cost); 
                btn.disabled = game.clicks.lt(cost); 
            });
            document.querySelectorAll('.world-unlock-btn').forEach(btn => { 
                let cost = new Decimal(btn.dataset.cost); 
                btn.disabled = game.clicks.lt(cost); 
            });
            document.querySelectorAll('.diamond-btn').forEach(btn => { 
                let cost = new Decimal(btn.dataset.cost); 
                btn.disabled = game.gems.lt(cost); 
            });

            if(currentEgg && document.getElementById('egg-buy-modal').style.display === 'flex') {
                let realAmount = 0;
                let eggCost = new Decimal(currentEgg.cost);
                if(eggBuyAmount === 'max') {
                    realAmount = game.clicks.div(eggCost).floor().toNumber();
                    if(realAmount < 1) realAmount = 1; if(realAmount > 200) realAmount = 200;
                } else { realAmount = eggBuyAmount; }
                let totalCost = eggCost.times(realAmount);
                document.getElementById('egg-cost-disp').innerHTML = `<i class="bi bi-cursor-fill"></i> ${formatNumber(totalCost)}`;
                let buyBtn = document.querySelector('.btn-buy-once');
                if(game.clicks.lt(totalCost)) {
                    buyBtn.style.opacity = 0.5; buyBtn.style.pointerEvents = 'none'; buyBtn.style.background = '#95a5a6';
                } else {
                    buyBtn.style.opacity = 1; buyBtn.style.pointerEvents = 'auto'; buyBtn.style.background = '#2ecc71';
                }
            }
            
            for(let key in game.buffs) {
                let el = document.getElementById(`buff-timer-${key}`);
                if(el) {
                    let min = Math.floor(game.buffs[key]/60);
                    let sec = Math.floor(game.buffs[key]%60);
                    el.innerText = `${min}:${sec.toString().padStart(2,'0')}`;
                }
            }
        }

        function updateProgressBar() {
            let currentWorld = WORLDS[game.world];
            let nextWorld = WORLDS[game.world + 1];
            
            if (nextWorld) {
                let currentCost = new Decimal(currentWorld.cost);
                let nextCost = new Decimal(nextWorld.cost);
                let range = nextCost.sub(currentCost);
                let progress = game.clicks.sub(currentCost);
                if (progress.lt(0)) progress = new Decimal(0);
                
                let pct = progress.div(range).times(100).toNumber();
                if (pct > 100) pct = 100;
                if (pct < 0) pct = 0;

                document.getElementById('world-progress-bar').style.width = pct + "%";
                document.getElementById('world-progress-text').innerText = `次のワールドまで: ${pct.toFixed(2)}%`;
            } else {
                document.getElementById('world-progress-bar').style.width = "100%";
                document.getElementById('world-progress-text').innerText = "MAX WORLD REACHED";
            }
        }
        
        function updateBuffDisplay() {
            const buffContainer = document.getElementById('active-buffs');
            let currentChildren = buffContainer.childElementCount;
            let buffKeys = Object.keys(game.buffs);
            if(currentChildren === buffKeys.length) return;

            buffContainer.innerHTML = "";
            for(let key in game.buffs) {
                let item = DIAMOND_SHOP.find(x=>x.id===key);
                if(item) {
                    let min = Math.floor(game.buffs[key]/60);
                    let sec = Math.floor(game.buffs[key]%60);
                    let div = document.createElement('div');
                    div.className = 'buff-pill buff-intro'; 
                    div.innerHTML = `<i class="bi ${item.icon}"></i> <span id="buff-timer-${key}">${min}:${sec.toString().padStart(2,'0')}</span>`;
                    div.style.borderColor = RARITY_COLORS[item.rarity];
                    div.onpointermove = (e) => showTooltip(e, item.name, item.desc, `<div style="color:${RARITY_COLORS[item.rarity]}">${item.rarity}</div>`, RARITY_COLORS[item.rarity]);
                    div.onpointerleave = hideTooltip;
                    buffContainer.appendChild(div);
                }
            }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            const tabs = ['upgrades','eggs','pets','shop','worlds','rebirth'];
            document.querySelectorAll('.tab-btn')[tabs.indexOf(id)].classList.add('active');
            document.querySelector('.bulk-controls').style.display = (id === 'upgrades') ? 'flex' : 'none';
        }

        /* --- RENDER UPGRADES --- */
        function renderUpgrades() {
            const cont = document.getElementById('tab-upgrades');
            cont.innerHTML = "";
            BUILDING_TYPES.forEach(b => {
                let lvl = game.buildings[b.id] || 0;
                let isLocked = game.world < b.worldReq; 
                if(isLocked && b.worldReq > 0) return;
                
                let amount = 0, cost = new Decimal(0);
                if(buyMode === 'max') {
                    amount = getMaxBuyable(b, lvl, game.clicks);
                    if(amount === 0) { amount = 1; cost = getSingleCost(b, lvl); }
                    else { cost = getBulkCost(b, lvl, amount); }
                } else {
                    amount = buyMode;
                    cost = getBulkCost(b, lvl, amount);
                }

                let typeBadge = '';
                if(b.type === 'auto') typeBadge = '<span class="item-type-badge badge-auto">自動</span>';
                if(b.type === 'click') typeBadge = '<span class="item-type-badge badge-click">クリック</span>';
                if(b.type === 'gold') typeBadge = '<span class="item-type-badge badge-gold">ゴールド</span>';
                if(b.type === 'diamond') typeBadge = '<span class="item-type-badge badge-diamond">ダイヤ</span>';
                if(b.type === 'diamond_chance' || b.type === 'crit_chance') typeBadge = '<span class="item-type-badge badge-chance">確率UP</span>';

                let div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <div class="item-icon"><i class="bi ${b.icon}"></i></div>
                    <div>
                        <div style="font-weight:bold;">${b.name} <span style="font-size:0.8rem; background:#333; color:white; padding:2px 8px; border-radius:10px;">Lv.${lvl}</span> ${typeBadge}</div>
                        <div style="font-size:0.8rem; opacity:0.8;">${b.desc}</div>
                    </div>
                    <button class="buy-btn upgrade-buy-btn" data-cost="${cost}" onclick="buyBuilding('${b.id}')">
                        <div>${amount===0?'1':amount}個購入</div>
                        <div style="font-size:0.8rem;"><i class="bi bi-cursor-fill"></i> ${formatNumber(cost)}</div>
                    </button>
                `;
                cont.appendChild(div);
            });
            updateUI(cachedAutoCPS, manualClickHistory.length);
        }

        function buyBuilding(id) {
            let b = BUILDING_TYPES.find(x => x.id === id);
            if(!b) return;
            let lvl = game.buildings[id] || 0;
            let amount = 0, cost = new Decimal(0);
            if(buyMode === 'max') {
                amount = getMaxBuyable(b, lvl, game.clicks);
                if(amount > 0) cost = getBulkCost(b, lvl, amount);
            } else {
                amount = buyMode;
                cost = getBulkCost(b, lvl, amount);
            }
            if (amount > 0 && game.clicks.gte(cost)) {
                game.clicks = game.clicks.sub(cost);
                game.buildings[id] = lvl + amount;
                recalcStats();
                renderUpgrades();
            }
        }

        /* --- EGGS --- */
        function renderEggs() {
            const cont = document.getElementById('egg-list'); cont.innerHTML = "";
            EGGS.forEach(egg => {
                let div = document.createElement('div'); div.className = 'item-card';
                let tt = egg.pets.map(p=>`<div class="rarity-row"><span style="color:${RARITY_COLORS[p.rarity]}">${p.name}</span><span>${(p.chance*100).toFixed(0)}%</span></div>`).join('');
                div.onpointermove = (e) => showTooltip(e, egg.name, `Pets:`, tt);
                div.onpointerleave = hideTooltip;
                div.innerHTML = `
                    <div class="item-icon" style="border-color:#ffeaa7;"><i class="bi bi-egg-fill" style="color:#ffeaa7;"></i></div>
                    <div><div style="font-weight:bold;">${egg.name}</div><div style="font-size:0.8rem;">${egg.pets.length}種類のペット</div></div>
                    <button class="buy-btn" onclick="openEggModal(${egg.id})">購入画面へ</button>
                `;
                cont.appendChild(div);
            });
        }
        function openEggModal(id) {
            currentEgg = EGGS.find(e => e.id === id);
            document.getElementById('modal-egg-name').innerText = currentEgg.name;
            selectEggAmount(1);
            stopAutoHatch(); 
            document.getElementById('egg-buy-modal').style.display = 'flex';
            updateUI(cachedAutoCPS, manualClickHistory.length);
        }
        function selectEggAmount(amt) {
            eggBuyAmount = amt;
            document.querySelectorAll('.amt-btn').forEach(b => b.classList.remove('selected'));
            let btns = document.querySelectorAll('.amt-btn');
            for(let btn of btns) { if(btn.innerText === (amt === 'max' ? "MAX" : amt.toString())) btn.classList.add('selected'); }
            updateUI(cachedAutoCPS, manualClickHistory.length);
        }
        function toggleAutoHatch() {
            autoHatchEnabled = !autoHatchEnabled;
            let btn = document.getElementById('btn-auto-hatch');
            let txt = document.getElementById('auto-status-text');
            if(autoHatchEnabled) {
                btn.classList.add('active'); txt.innerText = "ON"; executeBuyEgg();
            } else { stopAutoHatch(); }
        }
        function stopAutoHatch() {
            autoHatchEnabled = false; if(autoHatchTimer) clearTimeout(autoHatchTimer);
            let btn = document.getElementById('btn-auto-hatch');
            let txt = document.getElementById('auto-status-text');
            if(btn) btn.classList.remove('active'); if(txt) txt.innerText = "OFF";
        }
        function executeBuyEgg() {
            if(!currentEgg) return;
            let realAmount = 0;
            let eggCost = new Decimal(currentEgg.cost);
            if(eggBuyAmount === 'max') {
                realAmount = game.clicks.div(eggCost).floor().toNumber();
                if(realAmount < 1) { if(autoHatchEnabled) stopAutoHatch(); return; }
                if(realAmount > 200) realAmount = 200;
            } else { realAmount = eggBuyAmount; }
            let cost = eggCost.times(realAmount);
            if(game.clicks.gte(cost)) {
                game.clicks = game.clicks.sub(cost);
                if(!autoHatchEnabled) closeModal('egg-buy-modal');
                hatchPets(realAmount);
            } else { if(autoHatchEnabled) stopAutoHatch(); }
        }
        function hatchPets(amount) {
            const modal = document.getElementById('hatch-modal');
            const grid = document.getElementById('hatch-result-container');
            grid.innerHTML = ""; modal.style.display = 'flex';
            for(let i=0; i<amount; i++) {
                let r = Math.random(), c = 0, pet = currentEgg.pets[0];
                for(let p of currentEgg.pets) { c += p.chance; if(r <= c) { pet = p; break; } }
                game.inventory.push({ uid: Date.now()+Math.random(), name: pet.name, rarity: pet.rarity, power: pet.power, equipped: false });
                let card = document.createElement('div'); card.className = 'hatch-card'; 
                card.style.borderColor = RARITY_COLORS[pet.rarity]; 
                card.style.animationDelay = (i*0.05)+'s';
                card.innerHTML = `<i class="bi bi-egg-fill" style="color:${RARITY_COLORS[pet.rarity]};"></i><div class="hatch-name">${pet.name}</div><div class="hatch-rarity" style="color:${RARITY_COLORS[pet.rarity]};">${pet.rarity}</div>`;
                grid.appendChild(card);
            }
            renderInventory(); recalcStats();
            if(autoHatchEnabled) autoHatchTimer = setTimeout(() => executeBuyEgg(), 1000);
        }
        function closeHatchModal() { stopAutoHatch(); closeModal('hatch-modal'); }

        /* --- DIAMOND SHOP --- */
        function renderShop() {
            const cont = document.getElementById('tab-shop'); cont.innerHTML = "";
            DIAMOND_SHOP.forEach(i => {
                let div = document.createElement('div'); div.className = 'item-card diamond-item';
                div.innerHTML = `<div class="item-icon" style="background:white;"><i class="bi ${i.icon}" style="color:#00d2ff;"></i></div><div><div style="font-weight:bold;">${i.name}</div><div style="font-size:0.8rem;">${i.desc}</div></div><button class="buy-btn diamond-btn" data-cost="${i.cost}" onclick="buyDiamondItem('${i.id}')"><i class="bi bi-gem-fill"></i> ${formatNumber(i.cost)}</button>`;
                cont.appendChild(div);
            });
            updateUI(cachedAutoCPS, manualClickHistory.length);
        }
        function buyDiamondItem(id) {
            let item = DIAMOND_SHOP.find(x=>x.id===id);
            let cost = new Decimal(item.cost);
            if(game.gems.gte(cost)) {
                game.gems = game.gems.sub(cost);
                if(item.type==='buff') {
                    if(game.buffs[id]) game.buffs[id] += item.duration; else game.buffs[id] = item.duration;
                    recalcStats();
                    showNotification(`${item.name}を発動しました！`, 'success');
                }
                else if(item.type==='pet') {
                    game.inventory.push({uid:Date.now(), name:item.name, rarity:item.rarity, power:item.power, equipped:false});
                    renderInventory();
                    showItemGetModal("bi-egg-fill", item.name, item.rarity, "ペット獲得！");
                }
                else if(item.type==='perm') {
                    if(!game.permBuffs) game.permBuffs = { click:0, auto:0, luck:0 };
                    if(id==='perm_click') game.permBuffs.click += 1;
                    if(id==='perm_auto') game.permBuffs.auto += 1;
                    if(id==='perm_luck') game.permBuffs.luck += 1;
                    recalcStats();
                    showNotification(`${item.name}を獲得！永続強化！`, 'success');
                }
                updateUI(cachedAutoCPS, manualClickHistory.length);
            }
        }
        function showItemGetModal(icon, name, rarity, sub) {
            const modal = document.getElementById('hatch-modal');
            const grid = document.getElementById('hatch-result-container');
            grid.innerHTML = ""; modal.style.display = 'flex';
            let card = document.createElement('div'); card.className = 'hatch-card';
            card.style.borderColor = RARITY_COLORS[rarity]; card.style.transform = "scale(1)"; card.style.opacity = "1";
            card.innerHTML = `<i class="bi ${icon}" style="color:${RARITY_COLORS[rarity]};"></i><div class="hatch-name">${name}</div><div class="hatch-rarity" style="color:${RARITY_COLORS[rarity]};">${sub}</div>`;
            grid.appendChild(card);
        }

        /* --- UTILS --- */
        function renderInventory() {
            const cont = document.getElementById('inventory-container'); cont.innerHTML = "";
            let equipped = 0;
            game.inventory.sort((a,b) => (a.equipped===b.equipped)?(b.power-a.power):(a.equipped?-1:1));
            game.inventory.forEach(p => {
                if(p.equipped) equipped++;
                let div = document.createElement('div'); div.className = 'pet-slot'; div.style.borderColor = RARITY_COLORS[p.rarity];
                if(p.equipped) div.innerHTML += `<div class="equipped-marker"></div>`;
                div.innerHTML += `<i class="bi bi-reddit" style="color:${RARITY_COLORS[p.rarity]}"></i>`;
                div.onclick = () => { if(!p.equipped && game.inventory.filter(x=>x.equipped).length>=5) return showNotification("装備上限は5体です", 'error'); p.equipped=!p.equipped; renderInventory(); recalcStats(); };
                div.onpointermove = (e) => showTooltip(e, p.name, `パワー: x${formatNumber(p.power)}`, `<span style="color:${RARITY_COLORS[p.rarity]}">${p.rarity}</span>`, RARITY_COLORS[p.rarity]);
                div.onpointerleave = hideTooltip;
                cont.appendChild(div);
            });
            document.getElementById('equip-count').innerText = equipped;
        }
        function equipBest() {
            game.inventory.forEach(p=>p.equipped=false);
            game.inventory.sort((a,b)=>b.power-a.power);
            for(let i=0; i<Math.min(5, game.inventory.length); i++) game.inventory[i].equipped=true;
            renderInventory(); recalcStats();
        }
        function renderWorlds() {
            const cont = document.getElementById('worlds-list'); cont.innerHTML = "";
            let nextLocked = null;
            
            WORLDS.forEach(w => {
                let unlocked = w.id <= game.world;
                let canBuy = w.id === game.world + 1;
                if(canBuy) nextLocked = w;
                let wCost = new Decimal(w.cost);

                let btn = unlocked ? `<button class="buy-btn" style="background:#3498db; border-color:#2980b9;" onclick="changeWorld(${w.id})">テレポート</button>` : (canBuy ? `<button class="buy-btn world-unlock-btn" data-cost="${w.cost}" onclick="unlockWorld(${w.id})">解放: ${formatNumber(wCost)}</button>` : `<button class="buy-btn" disabled>ロック</button>`);
                let div = document.createElement('div'); div.className = `item-card ${!unlocked&&!canBuy?'locked-upgrade':''}`;
                if(game.world===w.id) div.style.borderColor = "#2ecc71";
                div.innerHTML = `<div class="item-icon"><i class="bi bi-globe"></i></div><div><div style="font-weight:bold;">${w.name}</div><div style="font-size:0.8rem;">倍率: x${formatNumber(w.multi)}</div></div>${btn}`;
                if(!unlocked&&!canBuy) div.innerHTML+=`<div class="lock-overlay"><i class="bi bi-lock-fill"></i></div>`;
                cont.appendChild(div);
            });

            // Update Time Estimator
            if(nextLocked && cachedAutoCPS.gt(0)) {
                let wCost = new Decimal(nextLocked.cost);
                let needed = wCost.sub(game.clicks);
                if(needed.lt(0)) needed = new Decimal(0);
                let time = needed.div(cachedAutoCPS).toNumber();
                document.getElementById('next-world-timer').innerText = `次のワールド (${nextLocked.name}) まで: ${formatTime(time)}`;
            } else if (!nextLocked) {
                document.getElementById('next-world-timer').innerText = "全ワールド解放済み！";
            } else {
                document.getElementById('next-world-timer').innerText = "自動クリックが必要です";
            }
        }
        function unlockWorld(id) {
            let cost = new Decimal(WORLDS[id].cost);
            if(game.clicks.gte(cost)) { 
                game.clicks = game.clicks.sub(cost); 
                game.world=id; 
                changeWorld(id); 
                renderWorlds(); renderUpgrades(); recalcStats(); 
            }
        }
        function changeWorld(id, force) {
            if(game.world!==id && !force) game.world=id;
            let w = WORLDS[id]; document.body.style.background = w.bg;
            document.getElementById('world-badge').innerHTML = `<i class="bi bi-globe"></i> ${w.name}`;
            if(audioPlayer.src !== w.music) { audioPlayer.src = w.music; audioPlayer.play().catch(()=>{}); }
            renderUpgrades(); recalcStats();
        }
        function doRebirth() {
            let cost = new Decimal(5e7).times(Decimal.pow(15, game.rebirths));
            if(game.clicks.gte(cost)) {
                game.clicks=new Decimal(0); game.rebirths++; game.buildings={}; game.world=0;
                changeWorld(0); renderUpgrades(); renderWorlds(); recalcStats(); 
                closeModal('rebirth-modal');
                showNotification("リバース成功！永続倍率獲得！", 'success');
            }
        }
        function saveGame() { localStorage.setItem('ps99_infinity_v7.0_save', JSON.stringify(game)); showNotification("データ保存完了", 'save'); }
        function loadGame() {
            let saved = localStorage.getItem('ps99_infinity_v7.0_save');
            if(saved) {
                try { 
                    let parsed = JSON.parse(saved); 
                    if(parsed.version >= 3.0) { 
                        parsed.clicks = new Decimal(parsed.clicks);
                        parsed.gems = new Decimal(parsed.gems);
                        game = { ...game, ...parsed }; 
                    } 
                } catch(e) {}
            }
        }
        function downloadSave() { let a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(game)],{type:'application/json'})); a.download=`ps99_save.json`; a.click(); }
        function uploadSave(i) {
            let r=new FileReader(); r.onload=e=>{ 
                try{ 
                    let d = JSON.parse(e.target.result); 
                    if(d.version >= 3.0) { 
                        d.clicks = new Decimal(d.clicks);
                        d.gems = new Decimal(d.gems);
                        game={...game, ...d}; 
                        renderUpgrades(); renderInventory(); renderWorlds(); recalcStats(); 
                        showNotification("復元完了", 'success'); 
                    } 
                }catch(x){showNotification("エラー", 'error');} 
            };
            if(i.files[0]) r.readAsText(i.files[0]);
        }
        function hardReset() { 
            if(confirm("本当に全データを削除しますか？\nこの操作は取り消せません。")) { 
                localStorage.removeItem('ps99_infinity_v7.0_save'); 
                showNotification("データを削除しました。リロードします...", 'success');
                setTimeout(() => location.reload(), 1500);
            } 
        }
        
        // Helper to format time (Seconds -> Readable)
        function formatTime(sec) {
            if(sec < 0) return "0s";
            if(!isFinite(sec)) return "---";
            if(sec > 3600*24) return ">1d";
            if(sec > 3600) return Math.floor(sec/3600) + "h " + Math.floor((sec%3600)/60) + "m";
            if(sec > 60) return Math.floor(sec/60) + "m " + Math.floor(sec%60) + "s";
            return Math.floor(sec) + "s";
        }

        window.openModal=function(id){ document.getElementById(id).style.display='flex'; }
        window.closeModal=function(id){ document.getElementById(id).style.display='none'; }
        
        const tooltip=document.getElementById('custom-tooltip');
        window.showTooltip=function(e,t,d,s,color){ 
            tooltip.style.display='block'; 
            tooltip.style.borderColor = color || 'rgba(255,255,255,0.2)';
            document.getElementById('tt-title').innerText=t; 
            document.getElementById('tt-desc').innerText=d; 
            document.getElementById('tt-stats').innerHTML=s||""; 
            moveTooltip(e); 
        }
        window.hideTooltip=function(){ tooltip.style.display='none'; }
        function moveTooltip(e){ let x=e.clientX+15, y=e.clientY+15; if(x+250>innerWidth)x-=260; if(y+150>innerHeight)y-=150; tooltip.style.left=x+'px'; tooltip.style.top=y+'px'; }
        document.addEventListener('pointermove', e => { if(tooltip.style.display==='block') moveTooltip(e); });
    </script>
</body>
</html>
